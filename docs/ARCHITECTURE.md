# MathVideo ç³»ç»Ÿæ¶æ„è¯¦è§£

## å®Œæ•´æµç¨‹å›¾ (Mermaid)

```mermaid
flowchart TB
    subgraph Input["ğŸ“¥ è¾“å…¥é˜¶æ®µ"]
        A[ç”¨æˆ·è¾“å…¥æ•°å­¦ä¸»é¢˜<br/>ä¾‹å¦‚: å‹¾è‚¡å®šç†]
    end

    subgraph Planning["ğŸ“‹ è§„åˆ’é˜¶æ®µ"]
        B[Planner Agent<br/>åˆ†é•œè§„åˆ’å™¨]
        B1[ç”Ÿæˆ storyboard.json<br/>åŒ…å«ç« èŠ‚ã€è®²ä¹‰ã€åŠ¨ç”»æè¿°]
    end

    subgraph Assets["ğŸ–¼ï¸ èµ„äº§é˜¶æ®µ"]
        C[Asset Manager<br/>èµ„äº§ç®¡ç†å™¨]
        C1{æœ‰ IconFinder<br/>API Key?}
        C2[ä¸‹è½½çœŸå®å›¾æ ‡]
        C3[ç”Ÿæˆ SVG å ä½ç¬¦]
        C4[æ›´æ–° storyboard<br/>æ·»åŠ èµ„äº§è·¯å¾„]
    end

    subgraph Generation["âš™ï¸ ç”Ÿæˆé˜¶æ®µ"]
        D[éå†æ¯ä¸ª Section]
        E[Coder Agent<br/>ä»£ç ç”Ÿæˆå™¨]
        E1[ç”Ÿæˆ Manim Python ä»£ç ]
        E2[ä¿å­˜åˆ° scripts/section_N.py]
    end

    subgraph Rendering["ğŸ¬ æ¸²æŸ“é˜¶æ®µ"]
        F[Manim æ¸²æŸ“å¼•æ“]
        F1{æ¸²æŸ“æˆåŠŸ?}
        F2[ç”Ÿæˆ MP4 è§†é¢‘]
        F3[æ•è·é”™è¯¯ä¿¡æ¯]
    end

    subgraph Fixing["ğŸ”§ ä¿®å¤é˜¶æ®µ"]
        G[Fixer Agent<br/>é”™è¯¯ä¿®å¤å™¨]
        G1[åˆ†æé”™è¯¯ä¿¡æ¯]
        G2[ç”Ÿæˆä¿®å¤åçš„ä»£ç ]
        G3{é‡è¯•æ¬¡æ•°<br/>< 4?}
    end

    subgraph Critique["ğŸ‘ï¸ è§†è§‰åˆ†æé˜¶æ®µ"]
        H{å¯ç”¨è§†è§‰åé¦ˆ?}
        H1[Visual Critic<br/>è§†è§‰æ‰¹è¯„å®¶]
        H2[FFmpeg æå–å…³é”®å¸§<br/>æ¯ç§’1å¸§, æœ€å¤š4å¸§]
        H3[å‘é€åˆ° Gemini 3 Pro<br/>è§†è§‰å¤§æ¨¡å‹]
        H4[åˆ†æå¸ƒå±€ã€å‡ ä½•æ­£ç¡®æ€§]
        H5{å‘ç°é—®é¢˜?}
    end

    subgraph Refining["âœ¨ ä¼˜åŒ–é˜¶æ®µ"]
        I[Refiner Agent<br/>ä»£ç ä¼˜åŒ–å™¨]
        I1[æ ¹æ®è§†è§‰åé¦ˆä¿®æ”¹ä»£ç ]
        I2[è°ƒæ•´åæ ‡ã€ç¼©æ”¾ã€é¢œè‰²]
        I3[é‡æ–°æ¸²æŸ“]
    end

    subgraph Output["ğŸ“¤ è¾“å‡ºé˜¶æ®µ"]
        J[æœ€ç»ˆè§†é¢‘æ–‡ä»¶]
        J1[output/ä¸»é¢˜/media/videos/]
    end

    %% ä¸»æµç¨‹è¿æ¥
    A --> B
    B --> B1
    B1 --> C
    C --> C1
    C1 -->|æ˜¯| C2
    C1 -->|å¦| C3
    C2 --> C4
    C3 --> C4
    C4 --> D

    D --> E
    E --> E1
    E1 --> E2
    E2 --> F
    F --> F1

    F1 -->|æˆåŠŸ| F2
    F1 -->|å¤±è´¥| F3

    F3 --> G
    G --> G1
    G1 --> G2
    G2 --> G3
    G3 -->|æ˜¯| F
    G3 -->|å¦| J1

    F2 --> H
    H -->|å¦| J
    H -->|æ˜¯| H1
    H1 --> H2
    H2 --> H3
    H3 --> H4
    H4 --> H5

    H5 -->|å¦| J
    H5 -->|æ˜¯| I
    I --> I1
    I1 --> I2
    I2 --> I3
    I3 --> J

    J --> J1

    %% æ ·å¼
    classDef input fill:#e1f5fe,stroke:#01579b
    classDef planning fill:#f3e5f5,stroke:#4a148c
    classDef assets fill:#fff3e0,stroke:#e65100
    classDef generation fill:#e8f5e9,stroke:#1b5e20
    classDef rendering fill:#fce4ec,stroke:#880e4f
    classDef fixing fill:#fff8e1,stroke:#f57f17
    classDef critique fill:#e3f2fd,stroke:#0d47a1
    classDef refining fill:#f1f8e9,stroke:#33691e
    classDef output fill:#e0f2f1,stroke:#004d40

    class A input
    class B,B1 planning
    class C,C1,C2,C3,C4 assets
    class D,E,E1,E2 generation
    class F,F1,F2,F3 rendering
    class G,G1,G2,G3 fixing
    class H,H1,H2,H3,H4,H5 critique
    class I,I1,I2,I3 refining
    class J,J1 output
```

## å„é˜¶æ®µè¯¦ç»†è¯´æ˜

### 1. è§„åˆ’é˜¶æ®µ (Planner)

**è¾“å…¥**: æ•°å­¦ä¸»é¢˜å­—ç¬¦ä¸² (å¦‚ "å‹¾è‚¡å®šç†")

**å¤„ç†**:
- è°ƒç”¨ Claude LLM
- ä½¿ç”¨ `PLANNER_PROMPT` æ¨¡æ¿
- ç”Ÿæˆç»“æ„åŒ–çš„ JSON åˆ†é•œè„šæœ¬

**è¾“å‡º**: `storyboard.json`
```json
{
  "topic": "å‹¾è‚¡å®šç†",
  "sections": [
    {
      "id": "section_1",
      "title": "ç›´è§’ä¸‰è§’å½¢ç™»åœº",
      "lecture_lines": ["ç›´è§’ä¸‰è§’å½¢", "ä¸‰è¾¹å‘½å", "ç›´è§’ 90Â°"],
      "animations": ["ä¸‰è§’å½¢æ·¡å…¥", "è¾¹é—ªçƒæ ‡æ³¨", "ç›´è§’æ ‡è®°"]
    }
  ]
}
```

### 2. èµ„äº§é˜¶æ®µ (Asset Manager)

**è¾“å…¥**: storyboard.json

**å¤„ç†**:
- åˆ†ææ•…äº‹æ¿å†…å®¹
- è¯†åˆ«éœ€è¦çš„å›¾æ ‡å…³é”®è¯
- å°è¯•ä» IconFinder ä¸‹è½½
- å¤±è´¥æ—¶ç”Ÿæˆ SVG å ä½ç¬¦

**è¾“å‡º**: `assets/` ç›®å½•ä¸‹çš„å›¾æ ‡æ–‡ä»¶

### 3. ç”Ÿæˆé˜¶æ®µ (Coder)

**è¾“å…¥**: å•ä¸ª section æ•°æ®

**å¤„ç†**:
- è°ƒç”¨ Claude LLM
- ä½¿ç”¨ `CODER_PROMPT` æ¨¡æ¿
- ç”Ÿæˆç»§æ‰¿è‡ª `TeachingScene` çš„ Manim ä»£ç 

**è¾“å‡º**: `scripts/section_N.py`

### 4. æ¸²æŸ“é˜¶æ®µ (Manim)

**è¾“å…¥**: Python è„šæœ¬æ–‡ä»¶

**å¤„ç†**:
- è°ƒç”¨ `manim -ql` å‘½ä»¤
- è®¾ç½® PYTHONPATH ç¡®ä¿å¯¼å…¥æ­£ç¡®
- æ•è·æ¸²æŸ“è¾“å‡ºå’Œé”™è¯¯

**è¾“å‡º**: MP4 è§†é¢‘æ–‡ä»¶ æˆ– é”™è¯¯ä¿¡æ¯

### 5. ä¿®å¤é˜¶æ®µ (Fixer)

**è§¦å‘æ¡ä»¶**: æ¸²æŸ“å¤±è´¥

**è¾“å…¥**: åŸå§‹ä»£ç  + é”™è¯¯ä¿¡æ¯

**å¤„ç†**:
- è°ƒç”¨ Claude LLM
- ä½¿ç”¨ `FIX_CODE_PROMPT` æ¨¡æ¿
- åˆ†æé”™è¯¯å¹¶ç”Ÿæˆä¿®å¤ä»£ç 

**è¾“å‡º**: ä¿®å¤åçš„ä»£ç  (æœ€å¤šé‡è¯• 4 æ¬¡)

### 6. è§†è§‰åˆ†æé˜¶æ®µ (Critic)

**è§¦å‘æ¡ä»¶**: æ¸²æŸ“æˆåŠŸ ä¸” `USE_VISUAL_FEEDBACK=True`

**è¾“å…¥**: MP4 è§†é¢‘æ–‡ä»¶

**å¤„ç†**:
1. FFmpeg æå–å…³é”®å¸§ (æ¯ç§’1å¸§, æœ€å¤š4å¸§)
2. Base64 ç¼–ç å›¾åƒ
3. å‘é€åˆ° Gemini 3 Pro è§†è§‰æ¨¡å‹
4. åˆ†æå¸ƒå±€ã€å‡ ä½•æ­£ç¡®æ€§ã€æ–‡å­—å¯è¯»æ€§

**è¾“å‡º**: JSON åé¦ˆ
```json
{
  "has_issues": true,
  "issues": ["ç›´è§’æ ‡è®°ä½ç½®é”™è¯¯", "æ ‡ç­¾ä¸å›¾å½¢é‡å "],
  "suggestion": "å°†ç›´è§’æ ‡è®°ç§»åŠ¨åˆ°æ­£ç¡®çš„é¡¶ç‚¹ä½ç½®"
}
```

### 7. ä¼˜åŒ–é˜¶æ®µ (Refiner)

**è§¦å‘æ¡ä»¶**: Critic å‘ç°é—®é¢˜

**è¾“å…¥**: åŸå§‹ä»£ç  + è§†è§‰åé¦ˆå»ºè®®

**å¤„ç†**:
- è°ƒç”¨ Claude LLM
- ä½¿ç”¨ `REFINE_CODE_PROMPT` æ¨¡æ¿
- ä»…è°ƒæ•´è§†è§‰å‚æ•°,ä¸æ”¹å˜é€»è¾‘

**è¾“å‡º**: ä¼˜åŒ–åçš„ä»£ç  â†’ é‡æ–°æ¸²æŸ“

## å…³é”®æŠ€æœ¯ç‚¹

### TeachingScene ç½‘æ ¼ç³»ç»Ÿ

```
å±å¹•åˆ†å‰²:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å·¦ä¾§ (è®²ä¹‰)    â”‚         å³ä¾§ (10x10 ç½‘æ ¼)          â”‚
â”‚                 â”‚  A1  A2  A3  ...  A10            â”‚
â”‚  â€¢ æ ‡é¢˜          â”‚  B1  B2  B3  ...  B10            â”‚
â”‚  â€¢ ç¬”è®° 1        â”‚  ...                             â”‚
â”‚  â€¢ ç¬”è®° 2        â”‚  J1  J2  J3  ...  J10            â”‚
â”‚  â€¢ ç¬”è®° 3        â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®šä½æ–¹æ³•

| æ–¹æ³• | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `place_at_grid` | å•ç‚¹å®šä½ | å°æ ‡ç­¾ã€ç‚¹ |
| `place_in_area` | åŒºåŸŸå®šä½ | å‡ ä½•å›¾å½¢ã€ç»„ |
| `add_side_label` | è¾¹æ ‡ç­¾ | ä¸‰è§’å½¢è¾¹ a, b, c |
| `add_vertex_label` | é¡¶ç‚¹æ ‡ç­¾ | é¡¶ç‚¹ A, B, C |
| `add_right_angle_mark` | ç›´è§’æ ‡è®° | ç›´è§’ä¸‰è§’å½¢ |

### é˜²é”™æœºåˆ¶

1. **LaTeX å›é€€**: æ—  LaTeX æ—¶è‡ªåŠ¨ä½¿ç”¨ Text æ›¿ä»£ MathTex
2. **é¢œè‰²åˆ«å**: å®šä¹‰ CYAN, NAVY ç­‰å¸¸è§é¢œè‰²é˜²æ­¢ NameError
3. **æ–‡æœ¬æ™ºèƒ½ç¼©æ”¾**: åªç¼©å°è¿‡é•¿æ–‡æœ¬,ä¸æ‹‰ä¼¸çŸ­æ–‡æœ¬
4. **æ ‡ç­¾å®šä½ä¿æŠ¤**: è¾…åŠ©æ–¹æ³•è‡ªåŠ¨è®¡ç®—æ­£ç¡®ä½ç½®
