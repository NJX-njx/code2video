# MathVideo ç³»ç»Ÿæ¶æ„è¯¦è§£

## å®Œæ•´æµç¨‹å›¾ (Mermaid)

```mermaid
flowchart TB
    subgraph Input["ğŸ“¥ è¾“å…¥é˜¶æ®µ"]
        A[ç”¨æˆ·è¾“å…¥æ•°å­¦ä¸»é¢˜<br/>+ å¯é€‰å›¾ç‰‡]
    end

    subgraph Routing["ğŸ”€ è·¯ç”±é˜¶æ®µ"]
        R[Router Agent<br/>ä»»åŠ¡ç±»å‹åˆ†ç±»]
        R1{ä»»åŠ¡ç±»å‹}
        R2[knowledge / problem<br/>ç‹¬ç«‹æ¨¡å¼]
        R3[geometry / proof<br/>é€’è¿›æ¨¡å¼]
    end

    subgraph Planning["ğŸ“‹ è§„åˆ’é˜¶æ®µ"]
        B[Planner Agent<br/>+ Skill æ³¨å…¥]
        B1[ç”Ÿæˆ storyboard.json<br/>å« inherited/new objects]
        B2[é¡¹ç›®ç›®å½•é‡å‘½å<br/>AI ç”Ÿæˆæœ‰æ„ä¹‰çš„åç§°]
    end

    subgraph Assets["ğŸ–¼ï¸ èµ„äº§é˜¶æ®µ"]
        C[Asset Manager]
        C1{æœ‰ IconFinder Key?}
        C2[ä¸‹è½½çœŸå®å›¾æ ‡]
        C3[ç”Ÿæˆ SVG å ä½ç¬¦]
        C4[æ›´æ–° storyboard]
    end

    subgraph Generation["âš™ï¸ ç”Ÿæˆé˜¶æ®µ"]
        D[éå†æ¯ä¸ª Section]
        E[Coder Agent<br/>+ Skill æ³¨å…¥]
        E1[ç‹¬ç«‹æ¨¡å¼: CODER_PROMPT]
        E2[é€’è¿›æ¨¡å¼: CODER_SEQUENTIAL_PROMPT<br/>ä¼ å…¥å‰åºä»£ç ]
        E3[ä¿å­˜ scripts/section_N.py]
    end

    subgraph Rendering["ğŸ¬ æ¸²æŸ“é˜¶æ®µ"]
        F[Manim æ¸²æŸ“å¼•æ“]
        F1{æ¸²æŸ“æˆåŠŸ?}
        F2[ç”Ÿæˆ MP4 è§†é¢‘]
        F3[æ•è·é”™è¯¯ä¿¡æ¯]
    end

    subgraph Fixing["ğŸ”§ ä¿®å¤é˜¶æ®µ"]
        G[Fixer Agent]
        G1[åˆ†æé”™è¯¯ â†’ ä¿®å¤ä»£ç ]
        G2{é‡è¯• < 3æ¬¡?}
    end

    subgraph Critique["ğŸ‘ï¸ è§†è§‰åˆ†æ"]
        H{å¯ç”¨è§†è§‰åé¦ˆ?}
        H1[Visual Critic<br/>Gemini â†’ Claude å›é€€]
        H2[FFmpeg æå–å¸§<br/>â†’ è§†è§‰æ¨¡å‹åˆ†æ]
        H3{å‘ç°é—®é¢˜?}
    end

    subgraph Refining["âœ¨ ä¼˜åŒ–é˜¶æ®µ"]
        I[Refiner Agent]
        I1[è°ƒæ•´åæ ‡/ç¼©æ”¾/é¢œè‰²<br/>â†’ é‡æ–°æ¸²æŸ“]
    end

    subgraph Merging["ğŸ¬ åˆå¹¶é˜¶æ®µ"]
        M[PyAV è§†é¢‘åˆå¹¶<br/>ffmpeg CLI å›é€€]
        M1[final_video.mp4]
    end

    %% ä¸»æµç¨‹
    A --> R
    R --> R1
    R1 --> R2
    R1 --> R3
    R2 --> B
    R3 --> B

    B --> B1 --> B2 --> C
    C --> C1
    C1 -->|æ˜¯| C2
    C1 -->|å¦| C3
    C2 --> C4
    C3 --> C4
    C4 --> D

    D --> E
    E --> E1
    E --> E2
    E1 --> E3
    E2 --> E3
    E3 --> F
    F --> F1

    F1 -->|æˆåŠŸ| F2
    F1 -->|å¤±è´¥| F3

    F3 --> G --> G1 --> G2
    G2 -->|æ˜¯| F
    G2 -->|å¦| M

    F2 --> H
    H -->|å¦| M
    H -->|æ˜¯| H1 --> H2 --> H3
    H3 -->|å¦| M
    H3 -->|æ˜¯| I --> I1 --> M

    M --> M1
```

## å„é˜¶æ®µè¯¦ç»†è¯´æ˜

### 0. è·¯ç”±é˜¶æ®µ (Router)

> v1.1 æ–°å¢

**è¾“å…¥**: ç”¨æˆ·æ–‡æœ¬ + å›¾ç‰‡æè¿°ï¼ˆå¦‚æœ‰ï¼‰

**å¤„ç†**:
- è°ƒç”¨ Claude LLM (temperature=0.1)
- ä½¿ç”¨ `ROUTER_PROMPT` åˆ¤æ–­ä»»åŠ¡ç±»å‹
- å®¹é”™è§£æï¼šç›´æ¥åŒ¹é… â†’ JSON â†’ æ–‡æœ¬æœç´¢ â†’ ä¸­æ–‡æ˜ å°„

**è¾“å‡º**: ä»»åŠ¡ç±»å‹ (`knowledge` / `geometry` / `problem` / `proof`)

**Section æ¨¡å¼å†³ç­–**:
| ä»»åŠ¡ç±»å‹ | Section æ¨¡å¼ | è¯´æ˜ |
|----------|-------------|------|
| `knowledge` | ç‹¬ç«‹ | å„èŠ‚äº’ä¸ä¾èµ– |
| `problem` | ç‹¬ç«‹ | å®¡é¢˜â†’å»ºæ¨¡â†’æ±‚è§£ç‹¬ç«‹ |
| `geometry` | **é€’è¿›** | åèŠ‚ç»§æ‰¿å‰èŠ‚å›¾å½¢ |
| `proof` | **é€’è¿›** | é€»è¾‘é“¾é€æ­¥æ¨å¯¼ |

### 1. è§„åˆ’é˜¶æ®µ (Planner)

**è¾“å…¥**: æ•°å­¦ä¸»é¢˜å­—ç¬¦ä¸² + ä»»åŠ¡ç±»å‹ + Skill æ³¨å…¥

**å¤„ç†**:
- è°ƒç”¨ Claude LLM
- æŒ‰ä»»åŠ¡ç±»å‹é€‰æ‹© Prompt: `PLANNER_PROMPT` / `PLANNER_GEOMETRY_PROMPT` / `PLANNER_PROOF_PROMPT`
- é€šè¿‡ SkillManager åŠ è½½ç»éªŒæŠ€å·§è¿½åŠ åˆ° Prompt æœ«å°¾
- ç”Ÿæˆç»“æ„åŒ–çš„ JSON åˆ†é•œè„šæœ¬

**è¾“å‡º**: `storyboard.json`
```json
{
  "topic": "ç­‰è¾¹ä¸‰è§’å½¢ä¸­çš„å¯¹ç§°ä¸äº¤ç‚¹æ„é€ ",
  "task_type": "geometry",
  "sections": [
    {
      "id": "section_1",
      "title": "æ„é€ ç­‰è¾¹ä¸‰è§’å½¢ ABC",
      "lecture_lines": ["ç­‰è¾¹ä¸‰è§’å½¢", "ä¸‰è¾¹ç›¸ç­‰", "å„è§’ 60Â°"],
      "animations": ["ä¸‰è§’å½¢æ·¡å…¥", "è¾¹æ ‡æ³¨", "è§’æ ‡è®°"],
      "inherited_objects": [],
      "new_objects": ["triangle_ABC", "labels"]
    }
  ]
}
```

### 2. é¡¹ç›®é‡å‘½å

> v1.1 æ–°å¢

**è§¦å‘**: Planner ç”Ÿæˆ storyboard å

**å¤„ç†**: ç”¨ storyboard çš„ AI ç”Ÿæˆ `topic` å­—æ®µé‡å‘½åè¾“å‡ºç›®å½•

**æ•ˆæœ**: `å·²çŸ¥ç­‰è¾¹ä¸‰è§’å½¢ABC-273bcf` â†’ `ç­‰è¾¹ä¸‰è§’å½¢ä¸­çš„å¯¹ç§°ä¸äº¤ç‚¹æ„é€ -75bd10`

### 3. èµ„äº§é˜¶æ®µ (Asset Manager)

**è¾“å…¥**: storyboard.json

**å¤„ç†**:
- åˆ†ææ•…äº‹æ¿å†…å®¹
- è¯†åˆ«éœ€è¦çš„å›¾æ ‡å…³é”®è¯
- å°è¯•ä» IconFinder ä¸‹è½½
- å¤±è´¥æ—¶ç”Ÿæˆ SVG å ä½ç¬¦

**è¾“å‡º**: `assets/` ç›®å½•ä¸‹çš„å›¾æ ‡æ–‡ä»¶

### 4. ç”Ÿæˆé˜¶æ®µ (Coder)

**è¾“å…¥**: å•ä¸ª section æ•°æ® + (é€’è¿›æ¨¡å¼) å‰åº Section ä»£ç 

**å¤„ç†**:
- è°ƒç”¨ Claude LLM
- æŒ‰æ¨¡å¼é€‰æ‹© Prompt: `CODER_PROMPT`ï¼ˆç‹¬ç«‹ï¼‰ / `CODER_SEQUENTIAL_PROMPT`ï¼ˆé€’è¿›ï¼‰
- é€šè¿‡ SkillManager æ³¨å…¥ç»éªŒæŠ€å·§
- ç”Ÿæˆç»§æ‰¿è‡ª `TeachingScene` çš„ Manim ä»£ç 

**é€’è¿›æ¨¡å¼å…³é”®**: Coder æ¥æ”¶ `previous_code` + `inherited_objects` + `new_objects`ï¼Œå…ˆ `self.add()` é™é»˜é‡å»ºç»§æ‰¿å¯¹è±¡ï¼Œå†åŠ¨ç”»å±•ç¤ºæ–°å¯¹è±¡ã€‚

**è¾“å‡º**: `scripts/section_N.py`

### 5. æ¸²æŸ“é˜¶æ®µ (Manim)

**è¾“å…¥**: Python è„šæœ¬æ–‡ä»¶

**å¤„ç†**:
- è°ƒç”¨ `manim -ql` å‘½ä»¤
- è®¾ç½® PYTHONPATH ç¡®ä¿å¯¼å…¥æ­£ç¡®
- æ•è·æ¸²æŸ“è¾“å‡ºå’Œé”™è¯¯

**è¾“å‡º**: MP4 è§†é¢‘æ–‡ä»¶ æˆ– é”™è¯¯ä¿¡æ¯

### 6. ä¿®å¤é˜¶æ®µ (Fixer)

**è§¦å‘æ¡ä»¶**: æ¸²æŸ“å¤±è´¥

**è¾“å…¥**: åŸå§‹ä»£ç  + é”™è¯¯ä¿¡æ¯

**å¤„ç†**:
- è°ƒç”¨ Claude LLM (temperature=0.2)
- ä½¿ç”¨ `FIX_CODE_PROMPT` æ¨¡æ¿
- åˆ†æé”™è¯¯å¹¶ç”Ÿæˆä¿®å¤ä»£ç 

**è¾“å‡º**: ä¿®å¤åçš„ä»£ç  (æœ€å¤šé‡è¯• 3 æ¬¡)

### 7. è§†è§‰åˆ†æé˜¶æ®µ (Critic)

**è§¦å‘æ¡ä»¶**: æ¸²æŸ“æˆåŠŸ ä¸” `USE_VISUAL_FEEDBACK=true`

**è¾“å…¥**: MP4 è§†é¢‘æ–‡ä»¶

**å¤„ç†**:
1. FFmpeg æå–å…³é”®å¸§ (æ¯ç§’1å¸§, æœ€å¤š4å¸§)
2. Base64 ç¼–ç å›¾åƒ
3. å‘é€åˆ° Gemini 3 Proï¼ˆä¼˜å…ˆï¼‰/ Claudeï¼ˆå›é€€ï¼‰è§†è§‰æ¨¡å‹
4. åˆ†æå¸ƒå±€ã€å‡ ä½•æ­£ç¡®æ€§ã€æ–‡å­—å¯è¯»æ€§

**è¾“å‡º**: JSON åé¦ˆ
```json
{
  "has_issues": true,
  "issues": ["ç›´è§’æ ‡è®°ä½ç½®é”™è¯¯", "æ ‡ç­¾ä¸å›¾å½¢é‡å "],
  "suggestion": "å°†ç›´è§’æ ‡è®°ç§»åŠ¨åˆ°æ­£ç¡®çš„é¡¶ç‚¹ä½ç½®"
}
```

### 8. ä¼˜åŒ–é˜¶æ®µ (Refiner)

**è§¦å‘æ¡ä»¶**: Critic å‘ç°é—®é¢˜

**è¾“å…¥**: åŸå§‹ä»£ç  + è§†è§‰åé¦ˆå»ºè®®

**å¤„ç†**:
- è°ƒç”¨ Claude LLM (temperature=0.3)
- ä½¿ç”¨ `REFINE_CODE_PROMPT` æ¨¡æ¿
- ä»…è°ƒæ•´è§†è§‰å‚æ•°,ä¸æ”¹å˜é€»è¾‘

**è¾“å‡º**: ä¼˜åŒ–åçš„ä»£ç  â†’ é‡æ–°æ¸²æŸ“

### 9. è§†é¢‘åˆå¹¶

> v1.1 æ–°å¢

**è§¦å‘æ¡ä»¶**: æœ‰ 2 ä¸ªä»¥ä¸Šåˆ†é•œæ¸²æŸ“æˆåŠŸ

**å¤„ç†**:
- ä¸»æ–¹æ¡ˆ: PyAV (Manim å†…ç½®ä¾èµ–) concat demuxer + decode/encode
- å›é€€æ–¹æ¡ˆ: CLI ffmpeg `-c copy`

**è¾“å‡º**: `final_video.mp4`

## Skill æ³¨å…¥ç³»ç»Ÿ

> v1.1 æ–°å¢

### å·¥ä½œåŸç†

```
mathvideo/skills/
â”œâ”€â”€ common/          â† æ‰€æœ‰ç±»å‹å…±ç”¨çš„æœ€ä½³å®è·µ
â”œâ”€â”€ geometry/        â† å‡ ä½•æ„é€ ä¸“ç”¨æŠ€å·§
â”œâ”€â”€ knowledge/       â† çŸ¥è¯†ç‚¹è®²è§£ä¸“ç”¨ï¼ˆå¾…æ‰©å……ï¼‰
â”œâ”€â”€ problem/         â† åº”ç”¨/è®¡ç®—é¢˜ä¸“ç”¨ï¼ˆå¾…æ‰©å……ï¼‰
â””â”€â”€ proof/           â† è¯æ˜æ¨å¯¼ä¸“ç”¨æŠ€å·§
```

`load_skills("geometry")` â†’ åŠ è½½ `common/` + `geometry/` ç›®å½•ä¸‹æ‰€æœ‰ `.md` æ–‡ä»¶ â†’ æ‹¼æ¥ä¸ºæ–‡æœ¬ â†’ è¿½åŠ åˆ° Planner å’Œ Coder çš„ Prompt æœ«å°¾ã€‚

**æ‰©å±•æ–¹å¼**: åœ¨å¯¹åº”ç›®å½•ä¸‹æ–°å»º `.md` æ–‡ä»¶å³å¯è‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚

## å…³é”®æŠ€æœ¯ç‚¹

### TeachingScene ç½‘æ ¼ç³»ç»Ÿ

```
å±å¹•åˆ†å‰²:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å·¦ä¾§ (è®²ä¹‰)    â”‚         å³ä¾§ (10Ã—10 ç½‘æ ¼)          â”‚
â”‚                 â”‚  A1  A2  A3  ...  A10            â”‚
â”‚  â€¢ æ ‡é¢˜          â”‚  B1  B2  B3  ...  B10            â”‚
â”‚  â€¢ ç¬”è®° 1        â”‚  ...                             â”‚
â”‚  â€¢ ç¬”è®° 2        â”‚  J1  J2  J3  ...  J10            â”‚
â”‚  â€¢ ç¬”è®° 3        â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®šä½æ–¹æ³•

| æ–¹æ³• | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `place_at_grid` | å•ç‚¹å®šä½ | å°æ ‡ç­¾ã€ç‚¹ |
| `place_in_area` | åŒºåŸŸå®šä½ | å‡ ä½•å›¾å½¢ã€ç»„ |
| `add_side_label` | è¾¹æ ‡ç­¾ | ä¸‰è§’å½¢è¾¹ a, b, c |
| `add_vertex_label` | é¡¶ç‚¹æ ‡ç­¾ | é¡¶ç‚¹ A, B, C |
| `add_right_angle_mark` | ç›´è§’æ ‡è®° | ç›´è§’ä¸‰è§’å½¢ |

### é˜²é”™æœºåˆ¶

1. **LaTeX å›é€€**: æ—  LaTeX æ—¶è‡ªåŠ¨ä½¿ç”¨ Text æ›¿ä»£ MathTex
2. **é¢œè‰²åˆ«å**: å®šä¹‰ CYAN, NAVY ç­‰å¸¸è§é¢œè‰²é˜²æ­¢ NameError
3. **æ–‡æœ¬æ™ºèƒ½ç¼©æ”¾**: åªç¼©å°è¿‡é•¿æ–‡æœ¬,ä¸æ‹‰ä¼¸çŸ­æ–‡æœ¬
4. **æ ‡ç­¾å®šä½ä¿æŠ¤**: è¾…åŠ©æ–¹æ³•è‡ªåŠ¨è®¡ç®—æ­£ç¡®ä½ç½®

## å‰ç«¯æ¶æ„

### Web æ¨¡å¼

```
æµè§ˆå™¨ (:3000) â”€â”€rewritesâ”€â”€â†’ FastAPI (:8000)
    â”‚                              â”‚
    â”‚  /api/*  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  /api/*
    â”‚  /static/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  /static/* (output/)
    â”‚
    â””â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  ws://localhost:8000/api/generate/ws/{task_id}
```

Next.js 14 App Router å…¨éƒ¨ä½¿ç”¨ `'use client'` æ¸²æŸ“ã€‚`next.config.js` é€šè¿‡ `rewrites` å°† API å’Œé™æ€æ–‡ä»¶ä»£ç†åˆ°åç«¯ã€‚

### Tauri æ¡Œé¢ç«¯æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tauri (Rust) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ WebView  â”‚ invoke  â”‚  Tauri Commands   â”‚   â”‚
â”‚  â”‚ (Next.js)â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  env_checker      â”‚   â”‚
â”‚  â”‚ :3000    â”‚         â”‚  backend_manager  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚ HTTP/WS                â”‚ subprocess   â”‚
â”‚       â–¼                        â–¼              â”‚
â”‚  FastAPI :8000    â† conda run -n mathvideo    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Tauri é€šè¿‡ Shell æ’ä»¶ç®¡ç† FastAPI å­è¿›ç¨‹ã€‚`next.config.js` æ£€æµ‹ `TAURI_ENV_PLATFORM` ç¯å¢ƒå˜é‡åˆ‡æ¢ `output: 'standalone'` æ¨¡å¼ï¼ˆä¸å¯ç”¨ rewritesï¼Œå‰ç«¯ç›´è¿ `:8000`ï¼‰ã€‚

### è®¾è®¡ç³»ç»Ÿ

CSS å˜é‡é©±åŠ¨çš„è¯­ä¹‰åŒ– Token ç³»ç»Ÿï¼Œæ”¯æŒæ˜ (Notion é£) / æš— (Apple é£) åŒä¸»é¢˜ã€‚ç»„ä»¶å±‚é‡‡ç”¨ shadcn/uiï¼ˆCVA + Radix UIï¼‰ï¼ŒåŠ¨ç”»å±‚ä½¿ç”¨ framer-motionã€‚è¯¦è§ [FRONTEND.md](./FRONTEND.md)ã€‚

### éƒ¨ç½²

æ”¯æŒ Tauri æ¡Œé¢å®‰è£…åŒ… (.msi / .dmg)ã€Web åœ¨çº¿éƒ¨ç½²ã€CLI è„šæœ¬ä¸‰ç§æ¨¡å¼ã€‚GitHub Actions CI/CD è‡ªåŠ¨æ„å»º Windows + macOS å¤šå¹³å°å®‰è£…åŒ…ã€‚è¯¦è§ [DEPLOYMENT.md](./DEPLOYMENT.md)ã€‚
